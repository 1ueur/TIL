메모리 레이아웃(Memory Layout)이란 프로세스 가상 메모리(Virtual Memory)의 구성입니다.
프로그램을 실행하면 운영체제는 프로세스에게 사용 가능한 메모리 공간을 할당해 주는데 이 공간을 가상 메모리라고 합니다.

## 프로세스 메모리 구조
### 섹션
윈도우의 PE 파일은 PE 헤더와 1개 이상의 섹션으로 구성되어 있습니다. 섹션이란 유사한 용도로 사용되는 데이터가 모여있는 영역입니다.

```.text``` 섹션에는 PE의 코드가 적혀있고, ```.data``` 섹션에는 PE가 실행 중에 참조하는 데이터가 적혀있습니다.

**PE 헤더에 저장되는 섹셕과 관련된 중요한 데이터**
- 섹션의 이름
- 섹션의 크기
- 섹션이 로드될 주소의 오프셋
- 섹션의 속성과 권한

윈도우가 PE를 실행할 때 이 정보를 참조하여 각 세션들을 가상 메모리의 적절한 세그먼트에 매핑하게 됩니다.
보통 ```.text``` ```.data``` ```.rdata``` 섹션이 많이 사용됩니다.

### .text
```.text``` 섹션은 **실행 가능한 기계 코드**가 위치하는 영역입니다. 이 세그먼트에는 **읽기 권한과 실행 권한**을 가집니다. 쓰기 권한은 공격자가 악의적인 코드를 넣기 쉽기 때문에 현재는 쓰기 권한을 제거하는 추세입니다.

```cpp
int main() { return 31337; }
```
정수 31337을 반환하는 main 함수가 컴파일 되어 554889e5b8697a00005dc3 라는 기계 코드로 변환되어 코드 세그먼트에 위치합니다.

### .data
```.data``` 섹션에는 **컴파일 시점에 값이 정해진 전역 변수**들이 위치합니다. **읽기 권한과 쓰기 권한**을 가집니다.

### .rdata
```.rdata``` 섹션에는 **컴파일 시점에 값이 정해진 전역 상수와 참조할 DLL 및 외부 함수들의 정보**가 저장됩니다. **읽기 권한**을 가지고 있고, 쓰기는 불가능합니다.

```cpp
const char data_rostr[] = "readonly_data";
char *str_ptr = "readonly";
```
> ```str_ptr```은 **전역 변수**로서 ```.data```에 위치하지만, ```"readonly"```는 **상수 문자열**로 취급되기 때문에 ```.rdata```에 위치합니다.

<br/>

## 다른 메모리들
### 스택
스택에는 보통 지역 변수나 함수의 리턴 주소가 저장됩니다. 자유롭게 읽고 쓸 수 있어야 하기 때문에 **읽기 권한과 쓰기 권한**을 가집니다. 
스택은 ```아래로 자란다```라는 표현을 많이 씁니다. 스택이 확장될 때, 기존 주소보다 낮은 주소로 확장되기 때문입니다.

### 힙
힙은 프로그램이 여러 용도로 사용하기 위해 할당받는 공간입니다. 모든 종류의 데이터가 저장될 수 있습니다. 스택과는 다르게 비교적 큰 데이터도 저장할 수 있고 전역적으로 접근이 가능하며 실행 중 동적으로 할당받을 수 있습니다.
일반적으로 **읽기 권한과 쓰기 권한**을 가지는데, 상황에 따라 실행 권한만 가질 때도 존재합니다.

```cpp
int main() {
  int *heap_data_ptr =
      malloc(sizeof(*heap_data_ptr));
      
  *heap_data_ptr = 31337;
  printf("%d\n", *heap_data_ptr);
  
  return 0;
}
```
```heap_data_ptr```에 ```malloc()```으로 동적 할당한 영역의 주소를 대입하고, 이 영역에 값을 씁니다.
```heap_data_ptr```은 지역 변수이므로 스택에 위치하며, ```malloc()```으로 할당 받은 힙 세그먼트의 주소를 가리킵니다.

<br/>

## 요약 📑
<table>
<tr><th>섹션</th><th>역할</th><th>일반적인 권한</th><th>사용 예</th></tr>
<tr><td>.text</td><td>실행 가능한 코드가 저장된 영역</td><td>읽기, 실행</td><td>main() 함수와 같은 코드</td></tr>
<tr><td>.data</td><td>초기화된 전역 변수가 위치하는 영역</td><td>읽기, 쓰기</td><td>초기화된 전역 변수, 전역 상수</td></tr>
<tr><td>.rdata</td><td>초기화된 전역 상수나 임포트 데이터가 위치하는 영역</td><td>읽기</td><td>전역 상수, 임포트 데이터</td></tr>
<tr><td>스택</td><td>일시적으로 저장하고 사용하는 임시 영역</td><td>읽기, 쓰기</td><td>지역 변수, 함수의 인자 등</td></tr>
<tr><td>힙</td><td>자유롭게 사용할 수 있는 영역</td><td>읽기, 쓰기</td><td>malloc(), calloc() 등으로 할당 받은 메모리</td></tr>
</table>